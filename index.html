function doPost(e) {
  try {
    // 設置 CORS 頭部
    const response = ContentService.createTextOutput();
    response.setMimeType(ContentService.MimeType.JSON);
    response.setHeader('Access-Control-Allow-Origin', '*');
    response.setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS');
    response.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    
    const action = e.parameter.action || (e.postData && JSON.parse(e.postData.contents).action);
    
    if (action === 'createOrder') {
      // 處理訂單邏輯
      const orderData = JSON.parse(e.postData.contents).orderData;
      
      // 寫入 Google Sheets 的邏輯
      const sheet = SpreadsheetApp.openById('您的試算表ID').getActiveSheet();
      sheet.appendRow([
        new Date(),
        orderData.orderId,
        orderData.customerName,
        orderData.customerPhone,
        orderData.items,
        orderData.totalAmount,
        orderData.pickupTime,
        orderData.deliveryAddress,
        orderData.notes,
        'pending'
      ]);
      
      return response.setContent(JSON.stringify({
        success: true,
        message: '訂單建立成功',
        data: { orderId: orderData.orderId, totalAmount: orderData.totalAmount }
      }));
    }
    
    return response.setContent(JSON.stringify({
      success: false,
      message: '未知的操作'
    }));
    
  } catch (error) {
    const response = ContentService.createTextOutput();
    response.setMimeType(ContentService.MimeType.JSON);
    response.setHeader('Access-Control-Allow-Origin', '*');
    return response.setContent(JSON.stringify({
      success: false,
      message: error.toString()
    }));
  }
}

// 處理 OPTIONS 請求（CORS 預檢）
function doOptions() {
  const response = ContentService.createTextOutput();
  response.setMimeType(ContentService.MimeType.JSON);
  response.setHeader('Access-Control-Allow-Origin', '*');
  response.setHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS');
  response.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  return response;
}
